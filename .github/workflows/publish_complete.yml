name: 'Publish: Complete (⚠️ use manually call only if necessary)'
# Note: display_title не задокументирован из-за чего в IDE может подчёркиваться строка
run-name: "${{ github.event_name == 'workflow_run' && format('{0}: Complete • {1} • {2}', github.event.workflow_run.display_title, github.event.workflow_run.head_branch, github.event.workflow_run.id) || format('Publish {0} {1} ({2}): Complete (⚠️ manually run)', inputs.package_name, inputs.git_release_tag, inputs.npm_tag) }}"

on:
  workflow_run:
    workflows: ['Publish release']
    types: [completed]
  # Note: только на случай, если потребуется ручной запуск
  workflow_dispatch:
    inputs:
      package_name:
        description: "package's name:"
        required: true
        type: choice
        options:
          - '@vkontakte/vkui'
          - '@vkontakte/vkui-floating-ui'
      git_release_tag:
        description: 'git release tag (ex: `v6.0.0`):'
        required: true
        type: string
      npm_tag:
        description: 'npm tag:'
        required: true
        type: choice
        options:
          - 'latest'
          - 'legacy'

jobs:
  payload:
    name: Prepare payload data
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.publish_workflow_payload.outputs.package_name || inputs.package_name }}
      npm_tag: ${{ steps.publish_workflow_payload.outputs.npm_tag || inputs.npm_tag }}
      git_release_tag: ${{ steps.publish_workflow_payload.outputs.git_release_tag || inputs.git_release_tag }}
      close_milestone: ${{ steps.publish_workflow_payload.outputs.close_milestone || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Download artifact (if it is 'workflow_run')
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.event == 'workflow_dispatch' && github.event.workflow_run.conclusion == 'success' }}
        id: artifact
        uses: actions/download-artifact@v5
        with:
          github-token: ${{ secrets.DEVTOOLS_GITHUB_TOKEN }}
          name: publish_workflow_payload
          path: publish_workflow_payload/
          run-id: ${{ github.event.workflow_run.id }}

      - name: Parse artifact
        if: ${{ steps.artifact.conclusion == 'success' }}
        id: publish_workflow_payload
        run: |
          echo "package_name=$(cat publish_workflow_payload/package_name.txt)" >> $GITHUB_OUTPUT
          echo "npm_tag=$(cat publish_workflow_payload/npm_tag.txt)" >> $GITHUB_OUTPUT
          echo "git_release_tag=$(cat publish_workflow_payload/git_release_tag.txt)" >> $GITHUB_OUTPUT
          echo "close_milestone=$(cat publish_workflow_payload/close_milestone.txt)" >> $GITHUB_OUTPUT

  package_vkui_complete:
    needs: ['payload']
    if: ${{ success() && fromJson(needs.payload.outputs.close_milestone) == true && needs.payload.outputs.package_name == '@vkontakte/vkui' }}
    runs-on: ubuntu-latest
    name: Complete @vkontakte/vkui
    steps:
      - name: Close milestone, comment on issues and release notes
        uses: VKCOM/gh-actions/VKUI/complete-publish@main
        with:
          token: ${{ secrets.DEVTOOLS_GITHUB_TOKEN }}
          releaseTag: ${{ needs.payload.outputs.git_release_tag }}
          latest: ${{ needs.payload.outputs.npm_tag == 'latest' }}

  package_vkui_floating_ui_complete:
    needs: ['payload']
    if: ${{ success() && needs.payload.outputs.package_name == '@vkontakte/vkui-floating-ui' }}
    runs-on: ubuntu-latest
    name: Complete @vkontakte/vkui-floating-ui
    steps:
      - name: get vkui-floating-ui version from git release tag
        id: vkui_floating_ui_version
        run: |
          TAG="${{ needs.payload.outputs.git_release_tag }}"
          VERSION="${TAG##*@}"
          echo "value=$VERSION" >> $GITHUB_OUTPUT

      # Обновляем версию vkui-floating-ui в vkui
      - name: update vkui-floating-ui version in vkui
        run: |
          yarn workspace @vkontakte/vkui add @vkontakte/vkui-floating-ui@${{ steps.vkui_floating_ui_version.outputs.value }}

      # Создаем pull request с изменениями в ветке
      - name: Create PR with changes
        id: create_pull_request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: ${{ env.RELEASE_BRANCH_NAME }}
          commit-message: 'build(deps): Bump @vkontakte/vkui-floating-ui to ${{ steps.vkui_floating_ui_version.outputs.value }}'
          delete-branch: true
          title: 'build(deps): Bump @vkontakte/vkui-floating-ui to ${{ steps.vkui_floating_ui_version.outputs.value }}'
          body: ''
          labels: subpackage:@vkontakte/vkui-floating-ui, dependencies

      # Добавляем майлстоун следующей минорной версии
      - name: Add next minor version milestone to pull request
        uses: VKCOM/gh-actions/VKUI/add-next-minor-milestone@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull_request_number: ${{ steps.create_pull_request.outputs.pull-request-number }}
