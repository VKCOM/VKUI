name: 'Deploy next version docs'

on:
  push:
    branches:
      - master
    paths:
      - 'website/**'
      - 'packages/vkui/**'
      # unit
      - '!packages/vkui/**/*.test.*'
      - '!packages/vkui/global.vitest.*'
      - '!packages/vkui/vitest.*.*'
      # e2e
      - '!packages/vkui/playwright/**'
      - '!packages/vkui/docker-compose.yml'
      - '!packages/vkui/playwright-ct.config.*'
      - '!packages/vkui/**/__image_snapshots__/*.png'
      # eslint
      - '!packages/vkui/.eslintrc.*'
      - '!packages/vkui/tsconfig.eslint.json'

env:
  AWS_S3_URL: https://${{ vars.AWS_BUCKET }}.${{ vars.AWS_ENDPOINT }}

concurrency:
  group: deploy-next-version-docs-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  cleanup:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    name: Cleanup
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Delete old artifacts for the next documentation version
        uses: VKCOM/gh-actions/VKUI/s3@main
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretAccessKey: ${{ secrets.AWS_SECRET_KEY }}
          awsBucket: ${{ vars.AWS_BUCKET }}
          awsEndpoint: https://${{ vars.AWS_ENDPOINT }}
          command: delete
          commandDeletePrefix: next/

  build_and_deploy_storybook:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    name: Deploy docs (storybook)
    needs: cleanup
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Build
        run: yarn docs:storybook:build

      - name: Upload to S3
        id: deploy
        uses: VKCOM/gh-actions/VKUI/s3@main
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretAccessKey: ${{ secrets.AWS_SECRET_KEY }}
          awsBucket: ${{ vars.AWS_BUCKET }}
          awsEndpoint: https://${{ vars.AWS_ENDPOINT }}
          command: upload
          commandUploadSrc: packages/vkui/storybook-static
          commandUploadDist: next/playground

      - name: Create doc url
        if: ${{ steps.deploy.outcome == 'success' }}
        id: url
        run: echo "${{ env.AWS_S3_URL }}/next/playground/index.html"

  build_and_deploy_docs_website:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    name: Deploy docs
    needs: cleanup
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Node setup
        uses: ./.github/actions/node-setup

      - name: Build VKUI
        run: yarn build:vkui

      - name: Build
        run: yarn docs:website:build
        env:
          NEXT_PUBLIC_VKUI_DOCS_BASE_PATH: /next

      - name: Upload to S3
        id: deploy
        uses: VKCOM/gh-actions/VKUI/s3@main
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretAccessKey: ${{ secrets.AWS_SECRET_KEY }}
          awsBucket: ${{ vars.AWS_BUCKET }}
          awsEndpoint: https://${{ vars.AWS_ENDPOINT }}
          command: upload
          commandUploadSrc: website/out
          commandUploadDist: next

      - name: Create doc url
        if: ${{ steps.deploy.outcome == 'success' }}
        id: url
        run: echo "${{ env.AWS_S3_URL }}/next/overview/about/index.html"
