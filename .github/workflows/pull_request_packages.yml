name: 'Pull Request / Packages'

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - '.husky/**'
      - '.codesandbox/**'
      - '.github/**'
      - '!.github/actions/**'
      - '.github/actions/**/*.yml'
      - '**/*.md'
      - '!packages/vkui/src/**/*.md'
      - '!styleguide/pages/**/*.md'
      - '**/__image_snapshots__/*.png'

concurrency:
  group: pr-packages-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  upload_workflow_payload_for_next_workflow:
    runs-on: ubuntu-latest
    name: Upload workflow payload artifact for next workflow
    steps:
      - name: Save PR number to txt file
        run: echo ${{ github.event.pull_request.number }} > PR_number.txt

      - name: Upload
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: workflow_payload
          path: PR_number.txt

  changed_files:
    runs-on: ubuntu-latest
    name: Detect what files changed
    outputs:
      package_vkui: ${{ steps.changes.outputs.package_vkui }}
      docs_styleguide: ${{ steps.changes.outputs.docs_styleguide }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Find changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: .github/file-filters.yml

  linters:
    runs-on: ubuntu-latest
    name: Run linters
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Run Stylelint
        run: yarn run lint:style

      - name: Run types checking
        run: yarn run lint:types

      - name: Run ESLint
        run: yarn run lint:es:ci

      - name: Check if the generated files have been updated
        run: yarn run lint:generated-files

      - name: Upload lint scripts artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lint-scripts-output
          path: lint-results.json

  test:
    name: Call reusable unit tests workflow
    uses: ./.github/workflows/reusable_workflow_test.yml

  test_e2e:
    if: ${{ needs.changed_files.outputs.package_vkui == 'true' }}
    needs: changed_files
    name: Call reusable e2e tests workflow
    uses: ./.github/workflows/reusable_workflow_test_e2e.yml

  test_e2e_prepare_and_upload_report:
    needs: test_e2e
    name: Prepare and upload e2e's HTML report artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Download Playwright blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v3
        with:
          name: all-blob-reports
          path: all-blob-reports

      - name: Merge Playwright blob reports into HTML Report
        run: yarn run playwright:cmd:merge-reports --reporter html ./all-blob-reports

      - name: Upload Playwright HTML report to GitHub Actions Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 30

  analyze_bundle_size:
    if: ${{ needs.changed_files.outputs.package_vkui == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Analyze bundle size
    env:
      CI_JOB_NUMBER: 1
    permissions:
      # Для возможности добавления комментария
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - uses: andresz1/size-limit-action@v1.7.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # only affects current branch
          skip_step: install
          directory: packages/vkui/
          # В 1.7.0 пока нет этого свойства. См. packages/vkui/yarn.lock
          # package_manager: yarn
          build_script: 'size:ci'

  styleguide:
    if: ${{ needs.changed_files.outputs.docs_styleguide == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Upload docs dist artifact (styleguide)
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Build
        run: yarn run docs:styleguide:build

      - name: Upload dist
        uses: actions/upload-artifact@v3
        with:
          name: styleguide-dist
          path: styleguide/dist

  storybook:
    if: ${{ needs.changed_files.outputs.docs_styleguide == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Upload docs dist artifact (storybook)
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Build
        run: yarn docs:storybook:build

      - name: Upload dist
        uses: actions/upload-artifact@v3
        with:
          name: storybook-dist
          path: packages/vkui/storybook-static
