name: 'Pull Request / Packages'

# > –ü—Ä–æ 'pull_request_target' –∏ –ø—Ä–æ —Ä–∏—Å–∫–∏ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –≤ —Å—Ç–∞—Ç—å–µ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ
# > https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
#
# –ü—Ä–∏ 'pull_request_target' —Å–≤–æ–π—Å—Ç–≤–æ `github.ref` –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å `refs/head/master`, –ø–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
# –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –µ–≥–æ –Ω–∞ `github.event.pull_request.number` —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
#
# –ü—Ä–∏–º–µ—Ä:
# ```
# - uses: actions/checkout@v3
#   with:
#     ref: refs/pull/${{ github.event.pull_request.number }}/merge
# ```
on:
  pull_request_target:
    paths-ignore:
      - 'tools/swc-transform-css-modules/**'
      - '.husky/**'
      - '.codesandbox/**'
      - '.github/**'
      - '!.github/actions/**'
      - '.github/actions/**/*.yml'
      - '**/*.md'
      - '!packages/vkui/src/**/*.md'
      - '!styleguide/pages/**/*.md'
      - '**/__image_snapshots__/*.png'

concurrency:
  group: pr-packages-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  changed_files:
    runs-on: ubuntu-latest
    name: Detect what files changed
    outputs:
      package_vkui: ${{ steps.changes.outputs.package_vkui }}
      docs_styleguide: ${{ steps.changes.outputs.docs_styleguide }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - name: Find changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          token: ${{ secrets.DEVTOOLS_GITHUB_TOKEN }}
          filters: .github/file-filters.yml

  linters:
    runs-on: ubuntu-latest
    name: Run linters
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Run Stylelint
        run: yarn run lint:style

      - name: Run types checking
        run: yarn run lint:types

      - name: Run ESLint
        run: yarn run lint:es:ci

      - name: Upload lint scripts artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lint-scripts-output
          path: lint-results.json

  test:
    name: Call reusable unit tests workflow
    uses: ./.github/workflows/reusable_workflow_test.yml
    with:
      ref: refs/pull/${{ github.event.pull_request.number }}/merge

  test_a11y:
    if: ${{ needs.changed_files.outputs.package_vkui == 'true' }}
    needs: changed_files
    name: Call reusable a11y tests workflow
    uses: ./.github/workflows/reusable_workflow_test_a11y.yml
    with:
      ref: refs/pull/${{ github.event.pull_request.number }}/merge

  test_e2e:
    if: ${{ needs.changed_files.outputs.package_vkui == 'true' }}
    needs: changed_files
    name: Call reusable e2e tests workflow
    uses: ./.github/workflows/reusable_workflow_test_e2e.yml
    with:
      ref: refs/pull/${{ github.event.pull_request.number }}/merge

  #
  # –£ `actions/download-artifact@v3` –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `if-no-files-found`, –ø–æ—ç—Ç–æ–º—É –¥–∂–æ–±–∞ `reporter_ci` –ø–∞–¥–∞–µ—Ç –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏
  # `e2e-output` & `a11y-output` (—Å–º. https://github.com/actions/download-artifact/issues/158)
  #
  # TODO –£–¥–∞–ª–∏—Ç—å –¥–∂–æ–±—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –¥–æ–±–∞–≤—è—Ç —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –∏ –º—ã –Ω–µ –Ω–∞—á–Ω—ë–º –∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
  test_e2e_fallback:
    if: ${{ needs.changed_files.outputs.package_vkui == 'false' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Call reusable e2e/a11y tests workflow (fallback for reporter)
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Create fake e2e-results.json (do not use it)
        run: touch fake-e2e-results.json

      - uses: actions/upload-artifact@v3
        with:
          name: e2e-output
          path: fake-e2e-results.json

      - name: Create fake a11y-results.json (do not use it)
        run: touch fake-a11y-results.json

      - uses: actions/upload-artifact@v3
        with:
          name: a11y-output
          path: fake-a11y-results.json

  analyze_bundle_size:
    if: ${{ needs.changed_files.outputs.package_vkui == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Analyze bundle size
    env:
      CI_JOB_NUMBER: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - uses: andresz1/size-limit-action@v1.7.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # only affects current branch
          skip_step: install
          directory: packages/vkui/
          # –í 1.7.0 –ø–æ–∫–∞ –Ω–µ—Ç —ç—Ç–æ–≥–æ —Å–≤–æ–π—Å—Ç–≤–∞. –°–º. packages/vkui/yarn.lock
          # package_manager: yarn
          build_script: 'size:ci'

  report_ci:
    if: ${{ always() }}
    needs:
      - linters
      - test
      - test_e2e
    runs-on: ubuntu-latest
    name: Report CI results
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Download lint scripts artifact
        uses: actions/download-artifact@v3
        with:
          name: lint-scripts-output

      - name: Download test artifact
        uses: actions/download-artifact@v3
        with:
          name: test-output

      - name: Download a11y artifact
        uses: actions/download-artifact@v3
        with:
          name: a11y-output

      - name: Download e2e artifact
        uses: actions/download-artifact@v3
        with:
          name: e2e-output

      - name: Build reporter action
        run: yarn install --frozen-lockfile --ignore-scripts && yarn run build
        working-directory: ./.github/actions/reporter

      - name: Push reports
        uses: ./.github/actions/reporter
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretKey: ${{ secrets.AWS_SECRET_KEY }}
          awsEndpoint: hb.bizmrg.com
          token: ${{ secrets.GITHUB_TOKEN }}

  styleguide:
    if: ${{ needs.changed_files.outputs.docs_styleguide == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Deploy docs (styleguide)
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Build styleguide
        run: yarn run docs:styleguide:build

      - name: Build S3 action
        if: ${{ github.actor != 'dependabot[bot]' }}
        run: yarn install --frozen-lockfile --ignore-scripts && yarn run build
        working-directory: ./.github/actions/s3

      - name: Upload styleguide S3
        if: ${{ github.actor != 'dependabot[bot]' }}
        uses: ./.github/actions/s3
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretAccessKey: ${{ secrets.AWS_SECRET_KEY }}
          awsBucket: vkui-screenshot
          awsEndpoint: hb.bizmrg.com
          command: upload
          commandUploadSrc: styleguide/dist/
          commandUploadDist: pull/${{ github.event.pull_request.number }}/${{ github.event.pull_request.head.sha }}/styleguide

  storybook:
    if: ${{ needs.changed_files.outputs.docs_styleguide == 'true' }}
    needs: changed_files
    runs-on: ubuntu-latest
    name: Deploy docs (storybook)
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-scripts

      - name: Build storybook
        run: yarn workspace @vkontakte/vkui build-storybook

      - name: Build s3 action
        if: ${{ github.actor != 'dependabot[bot]' }}
        run: yarn install --frozen-lockfile --ignore-scripts && yarn run build
        working-directory: ./.github/actions/s3

      - name: Upload storybook S3
        if: ${{ github.actor != 'dependabot[bot]' }}
        uses: ./.github/actions/s3
        with:
          awsAccessKeyId: ${{ secrets.AWS_ACCESS_KEY_ID }}
          awsSecretAccessKey: ${{ secrets.AWS_SECRET_KEY }}
          awsBucket: vkui-screenshot
          awsEndpoint: hb.bizmrg.com
          command: upload
          commandUploadSrc: packages/vkui/storybook-static
          commandUploadDist: pull/${{ github.event.pull_request.number }}/${{ github.event.pull_request.head.sha }}/storybook

  docs_comment:
    if: ${{ github.actor != 'dependabot[bot]' }}
    needs:
      - storybook
      - styleguide
    runs-on: ubuntu-latest
    name: Docs comment
    steps:
      - name: Find storybook URL comment
        uses: peter-evans/find-comment@v2
        id: find_url_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: <!-- storybook_url -->

      - name: Create or update comment
        if: steps.find_url_comment.outputs.comment-id == 0
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.find_url_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- storybook_url -->
            ## üëÄ Docs deployed

            - [Styleguide](https://vkui-screenshot.hb.bizmrg.com/pull/${{ github.event.pull_request.number }}/${{ github.event.pull_request.head.sha }}/styleguide/index.html)
            - [Storybook](https://vkui-screenshot.hb.bizmrg.com/pull/${{ github.event.pull_request.number }}/${{ github.event.pull_request.head.sha }}/storybook/index.html)

            Commit ${{ github.event.pull_request.head.sha }}
          edit-mode: replace
